name: Postman Unit Tests

on:
  push:
    branches: [ master, main, develop ]
  pull_request:
    branches: [ master, main, develop ]

jobs:
  collection-tests:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build and start collection test service
        working-directory: ./src
        run: |
          docker build -f collection/Dockerfile_test -t collection-test ./collection
          docker run -d --name collection-test -p 5000:5000 collection-test
          sleep 5

      - name: Install Newman
        run: npm install -g newman

      - name: Run Collection Postman tests
        run: |
          newman run docs/tests/collection_ut.postman_collection.json \
            --env-var "base_url=http://localhost:5000" \
            --reporters cli,json \
            --reporter-json-export collection-results.json

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: collection-test-results
          path: collection-results.json

      - name: Show logs on failure
        if: failure()
        run: docker logs collection-test

      - name: Cleanup
        if: always()
        run: docker rm -f collection-test || true

  game-history-tests:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build and start game history test service
        working-directory: ./src
        run: |
          docker build -f game_history/Dockerfile_test -t game-history-test ./game_history
          docker run -d --name game-history-test -p 5000:5000 game-history-test
          sleep 5

      - name: Install Newman
        run: npm install -g newman

      - name: Run Game History Postman tests
        run: |
          newman run docs/tests/game_history_ut.postman_collection.json \
            --env-var "base_url=http://localhost:5000" \
            --reporters cli,json \
            --reporter-json-export game-history-results.json

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: game-history-test-results
          path: game-history-results.json

      - name: Show logs on failure
        if: failure()
        run: docker logs game-history-test

      - name: Cleanup
        if: always()
        run: docker rm -f game-history-test || true

  user-manager-tests:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate secrets
        working-directory: ./src
        run: |
          mkdir -p secrets/user-manager
          python3 -c "import secrets; print(secrets.token_urlsafe(32))" > secrets/user-manager/encryption_key.txt
          python3 -c "import secrets; print(secrets.token_urlsafe(32))" > secrets/user-manager/jwt_secret_key.txt

      - name: Create test network
        run: docker network create test-network

      - name: Start MongoDB for user-manager
        run: |
          docker run -d --name user-mongo --network test-network \
            -e MONGO_INITDB_ROOT_USERNAME=user_admin \
            -e MONGO_INITDB_ROOT_PASSWORD=secure_password_user \
            -e MONGO_INITDB_DATABASE=user_auth_db \
            mongo:latest
          sleep 5

      - name: Build and start user-manager test service
        working-directory: ./src
        run: |
          docker build -f user-manager/Dockerfile -t user-manager-test ./user-manager
          docker run -d --name user-manager-test --network test-network -p 5004:5000 \
            -e MONGO_URI=mongodb://user_admin:secure_password_user@user-mongo:27017/user_auth_db?authSource=admin \
            -e ALGORITHM=HS256 \
            -e ACCESS_TOKEN_EXPIRE_MINUTES=30 \
            -v $(pwd)/secrets/user-manager:/run/secrets:ro \
            user-manager-test \
            uvicorn main:app --host 0.0.0.0 --port 5000
          sleep 5

      - name: Install Newman
        run: npm install -g newman

      - name: Run User Manager Postman tests
        run: |
          newman run docs/tests/user_manager_ut.postman_collection.json \
            --reporters cli,json \
            --reporter-json-export user-manager-results.json

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: user-manager-test-results
          path: user-manager-results.json

      - name: Show logs on failure
        if: failure()
        run: |
          echo "=== User Manager Logs ==="
          docker logs user-manager-test
          echo "=== MongoDB Logs ==="
          docker logs user-mongo

      - name: Cleanup
        if: always()
        run: |
          docker rm -f user-manager-test || true
          docker rm -f user-mongo || true
          docker network rm test-network || true

  test-summary:
    runs-on: ubuntu-latest
    needs: [collection-tests, game-history-tests, user-manager-tests]
    if: always()
    
    steps:
      - name: Check test results
        run: |
          if [ "${{ needs.collection-tests.result }}" = "failure" ] || \
             [ "${{ needs.game-history-tests.result }}" = "failure" ] || \
             [ "${{ needs.user-manager-tests.result }}" = "failure" ]; then
            echo "❌ Some tests failed"
            exit 1
          else
            echo "✅ All tests passed"
          fi