openapi: 3.0.0
info:
  title: "Match Service API"
  description: "API for managing game matches and leaderboards for a microservice."
  version: "1.0.0"
servers:
  - url: "/"
    description: "Relative server path"

paths:
  /addmatch:
    post:
      summary: "Add a new match"
      description: "Records the details of a completed match and updates the leaderboard."
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/NewMatch"
      responses:
        '201':
          description: "Match created successfully"
          content:
            application/json:
              schema:
                type: "object"
                properties:
                  status:
                    type: "string"
                    example: "ok"
                  match_id:
                    type: "string"
                    format: "uuid"
                    example: "a1b2c3d4-e5f6-7890-a1b2-c3d4e5f67890"
        '400':
          description: "Missing required match data"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        '500':
          description: "Database error"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /matches:
    get:
      summary: "List matches for the authenticated user"
      description: "Retrieves the latest matches for the user identified by the bearer token. Matches are returned in pages of 10 items sorted by start time (descending)."
      parameters:
        - in: header
          name: Authorization
          required: true
          schema:
            type: "string"
          description: "Bearer token issued by user-manager"
        - in: query
          name: page
          required: false
          schema:
            type: "integer"
            minimum: 0
            default: 0
          description: "Zero-based page index (10 matches per page)"
      responses:
        '200':
          description: "A list of matches for the authenticated player"
          content:
            application/json:
              schema:
                type: "array"
                items:
                  $ref: "#/components/schemas/MatchResponse"
        '401':
          description: "Missing or invalid token"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        '500':
          description: "Database error"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /leaderboard:
    get:
      summary: "Get the game leaderboard"
      description: "Retrieves the pre-computed leaderboard, sorted by total points (descending)."
      parameters:
        - in: query
          name: page
          required: false
          schema:
            type: "integer"
            minimum: 0
            default: 0
          description: "Zero-based page index (10 entries per page)"
      responses:
        '200':
          description: "The current leaderboard"
          content:
            application/json:
              schema:
                type: "array"
                items:
                  $ref: "#/components/schemas/LeaderboardEntry"
        '500':
          description: "Database error"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

components:
  schemas:
    NewMatch:
      type: "object"
      description: "Data required to create a new match entry."
      required:
        - player1
        - player2
        - winner
      properties:
        player1:
          type: "string"
          format: "uuid"
          description: "UUID of the first player"
        player2:
          type: "string"
          format: "uuid"
          description: "UUID of the second player"
        winner:
          type: "string"
          description: "Indicates the winner"
          enum: ["1", "2", "draw"]
        log:
          type: "array"
          items:
            type: "string"
          description: "A log of moves or events during the match (optional)"
        points1:
          type: "integer"
          description: "Points awarded to player 1 (optional)"
          default: 0
        points2:
          type: "integer"
          description: "Points awarded to player 2 (optional)"
          default: 0
        started_at:
          type: "integer"
          description: "Unix timestamp representing when the match started (optional)"
          default: 0
        ended_at:
          type: "integer"
          description: "Unix timestamp representing when the match ended (optional)"
          default: 0
      example:
        player1: "a1a1a1a1-b2b2-c3c3-d4d4-e5e5e5e5e5e5"
        player2: "f6f6f6f6-g7g7-h8h8-i9i9-j0j0j0j0j0j0"
        winner: "1"
        log: ["move1", "move2", "player 1 wins"]
        points1: 10
        points2: -5
        started_at: 1700000000
        ended_at: 1700000123

    MatchBase:
      type: "object"
      properties:
        player1:
          type: "string"
          description: "Display name of the first player"
        player2:
          type: "string"
          description: "Display name of the second player"
        winner:
          type: "string"
          enum: ["1", "2", "draw"]
        log:
          type: "array"
          items:
            type: "string"
        points1:
          type: "integer"
        points2:
          type: "integer"
        started_at:
          type: "integer"
          description: "Unix timestamp representing when the match started"
        ended_at:
          type: "integer"
          description: "Unix timestamp representing when the match ended"

    MatchResponse:
      type: "object"
      description: "Full match details as returned by the API"
      required:
        - _id
        - player1
        - player2
        - winner
      properties:
        _id:
          type: "string"
          description: "Match identifier assigned by the service"
        player1:
          type: "string"
          description: "Display name of player 1"
        player2:
          type: "string"
          description: "Display name of player 2"
        winner:
          type: "string"
          enum: ["1", "2", "draw"]
        log:
          type: "array"
          items:
            type: "string"
        points1:
          type: "integer"
        points2:
          type: "integer"
        started_at:
          type: "integer"
          description: "Unix timestamp representing when the match started"
        ended_at:
          type: "integer"
          description: "Unix timestamp representing when the match ended"
        row_number:
          type: "integer"
          description: "1-based position of the match within the paginated results"
      example:
        _id: "a1b2c3d4-e5f6-7890-a1b2-c3d4e5f67890"
        player1: "PlayerOne"
        player2: "PlayerTwo"
        winner: "1"
        log: ["move1", "move2"]
        points1: 10
        points2: -5
        started_at: 1700000000
        ended_at: 1700000123
        row_number: 1

    LeaderboardEntry:
      type: "object"
      description: "A single player's entry on the leaderboard"
      properties:
        username:
          type: "string"
          description: "Player's username"
        points:
          type: "integer"
          description: "Total points"
        wins:
          type: "integer"
          description: "Total number of wins"
        losses:
          type: "integer"
          description: "Total number of losses"
        draws:
          type: "integer"
          description: "Total number of draws"
      example:
        username: "PlayerOne"
        points: 150
        wins: 15
        losses: 3
        draws: 2

    Error:
      type: "object"
      properties:
        error:
          type: "string"
      example:
        error: "Match not found"