services:
  
  # ===============================================
  # 1. MICROSERVIZIO: GESTIONE UTENTI (AUTH)
  # ===============================================
  
  user-db:
    image: mongo:latest
    container_name: user_auth_db
    restart: always 
    ports:
      - "27017:27017" # Porta di default per il DB Utenti
    volumes:
      - user_mongo_data:/data/db 
    environment:
      MONGO_INITDB_ROOT_USERNAME: user_admin
      MONGO_INITDB_ROOT_PASSWORD: secure_password_user
      MONGO_INITDB_DATABASE: user_auth_db # Nome del DB Utenti
      
  profile-manager:
      build: 
        context: ./backend # Punta alla nuova cartella
      container_name: profile_manager_service
      # Esposto su una nuova porta (es. 5005)
      ports:
        - "5005:8000" 
      depends_on:
        - user-db
      environment:
        # Usa le stesse variabili d'ambiente di Auth
        MONGO_URI: mongodb://user_admin:secure_password_user@user-db:27017/user_auth_db?authSource=admin
        SECRET_KEY: "GUERRA_ASE_SECRET_KEY"
        ALGORITHM: "HS256"
        ACCESS_TOKEN_EXPIRE_MINUTES: 30
      
      # Monta i certificati per l'HTTPS e il codice
      volumes:
        - ./profile:/app
        - ./cert.pem:/app/cert.pem
        - ./key.pem:/app/key.pem

      command:
      - uvicorn main:app --host 0.0.0.0 --port 5000 --ssl-keyfile key.pem --ssl-certfile cert.pem --workers 4
# Definizione dei Volumi
volumes:
  user_mongo_data: