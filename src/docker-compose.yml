services:
  
  game_engine:
    build: ./game_engine
    ports:
      - "5001:5000"
    depends_on:
      - game_history
      - collection
      - user-manager  # <-- MODIFICA 1: Aggiungi questa dipendenza
    environment:
      GAME_ENGINE: "http://game_engine:5000/game"
      GAME_HISTORY_URL: "http://game_history:5000/addmatch"
      COLLECTION_URL: "http://collection:5000/collection"
      # --- MODIFICA 2: Aggiungi l'URL per il servizio utenti ---
      # Deve essere HTTPS e sulla porta INTERNA 5000 (come da comando uvicorn)
      USER_MANAGER_URL: "https://user-manager:5000" 

  game_history:
    build: ./game_history
    ports:
      - 5002:5000
    depends_on:
      - db-games
      - user-manager

  collection:
    build:
      dockerfile: collection/Dockerfile
    ports:
      - 5003:5000
    depends_on:
      - db-decks

  user-db:
    image: mongo:latest
    container_name: user_auth_db
    restart: always 
    ports:
      - "27017:27017" 
    volumes:
      - user_mongo_data:/data/db 
    environment:
      MONGO_INITDB_ROOT_USERNAME: user_admin
      MONGO_INITDB_ROOT_PASSWORD: secure_password_user
      MONGO_INITDB_DATABASE: user_auth_db
      
  user-manager:
    build: 
      context: ./user-manager/backend 
    container_name: user_manager_service
    ports:
      - "5004:5000" # Porta esterna 5004, porta interna 5000
    depends_on:
      - user-db
    environment:
      MONGO_URI: mongodb://user_admin:secure_password_user@user-db:27017/user_auth_db?authSource=admin
      SECRET_KEY: "GUERRA_ASE_SECRET_KEY"
      ALGORITHM: "HS256"
      ACCESS_TOKEN_EXPIRE_MINUTES: 30
    volumes:
      - ./user-manager/backend:/app
      - ./user-manager/cert.pem:/app/cert.pem
      - ./user-manager/key.pem:/app/key.pem
    command: uvicorn main:app --host 0.0.0.0 --port 5000 --ssl-keyfile key.pem --ssl-certfile cert.pem --workers 4

  # (Mantenuti i tuoi db-history, db-games, db-decks)
  db-history:
    image: mongo:latest
    volumes:
      - history-data:/data/db

  db-games:
    image: mongo:latest
    volumes:
      - games-data:/data/db

  db-decks:
    image: mongo:latest
    volumes:
      - decks-data:/data/db


volumes:
  history-data:
  games-data:
  decks-data:
  user_mongo_data:
