openapi: 3.0.3
info:
  title: Card Game API
  description: API for the card game engine.
  version: 1.0.1
servers:
  - url: /game
    description: Base path for the Game Engine (Blueprint prefix)

# =============================================================
#  ENDPOINT DEFINITIONS
# =============================================================
paths:
  /match/join:
    post:
      summary: Join matchmaking queue
      description: Adds an authenticated player to the matchmaking queue. If an opponent is waiting, a match is created immediately.
      tags:
        - Matchmaking
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Matchmaking result.
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: '#/components/schemas/WaitingForMatch'
                  - $ref: '#/components/schemas/MatchCreated'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/ServerError'

  /match/status:
    get:
      summary: Check matchmaking status
      description: Checks if the player has been matched to a game.
      tags:
        - Matchmaking
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Current matchmaking status.
          content:
            application/json:
              schema:
                oneOf:
                  - type: object
                    properties:
                      status:
                        type: string
                        example: "waiting"
                  - type: object
                    properties:
                      status:
                        type: string
                        example: "matched"
                      game_id:
                        type: string
                        format: uuid
                  - type: object
                    properties:
                      status:
                        type: string
                        example: "error"
                      message:
                        type: string
                        example: "You are not in the queue."
        '401':
          $ref: '#/components/responses/Unauthorized'

  /match/leave:
    post:
      summary: Leave matchmaking queue
      description: Removes the player from the matchmaking queue.
      tags:
        - Matchmaking
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Successfully left the queue.
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "cancelled"
        '401':
          $ref: '#/components/responses/Unauthorized'

  /deck/{game_id}:
    post:
      summary: Select deck slot
      description: An authenticated player selects the deck slot for the match. The server will contact the 'collection-service' to retrieve and validate the deck.
      tags:
        - Game Flow
      security:
        - bearerAuth: []
      parameters:
        - name: game_id
          in: path
          required: true
          description: The match ID.
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                deck_slot:
                  type: integer
                  description: The deck slot (e.g. 1, 2, 3...).
                  example: 1
              required:
                - deck_slot
      responses:
        '200':
          description: Deck selected. The response indicates if waiting for the opponent or if the match has started.
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Alice deck selected. Both ready! Game started, 3 cards drawn."
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/ServerError'

  /play/{game_id}:
    post:
      summary: Play a card
      description: An authenticated player plays a card from their hand.
      tags:
        - Game Flow
      security:
        - bearerAuth: []
      parameters:
        - name: game_id
          in: path
          required: true
          description: The match ID.
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                card:
                  $ref: '#/components/schemas/Card'
              required:
                - card
      responses:
        '200':
          description: Move executed. The response indicates the status (waiting, resolved, or finished).
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: '#/components/schemas/WaitingResponse'
                  - $ref: '#/components/schemas/ResolvedResponse'
                  - $ref: '#/components/schemas/FinishedResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /state/{game_id}:
    get:
      summary: Get match state
      description: Gets the current state of the game, including scores, turns, and winner.
      tags:
        - Game Management
      security:
        - bearerAuth: []
      parameters:
        - name: game_id
          in: path
          required: true
          description: The match ID.
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Current match state.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GameState'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /hand/{game_id}:
    get:
      summary: Get player's hand
      description: Gets the cards currently in the authenticated player's hand.
      tags:
        - Game Flow
      security:
        - bearerAuth: []
      parameters:
        - name: game_id
          in: path
          required: true
          description: The match ID.
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Player's hand.
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Card'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

# =============================================================
#  REUSABLE COMPONENTS
# =============================================================
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token obtained from the User Manager service

  schemas:
    Card:
      type: object
      properties:
        value:
          type: string
          example: "K"
        suit:
          type: string
          example: "clubs"
      required:
        - value
        - suit

    PlayerState:
      type: object
      properties:
        uuid:
          type: string
          format: uuid
        name:
          type: string
        hand_size:
          type: integer
          example: 3
        # Add 'hand' if you want to expose it (as in the test)
        # hand:
        #   type: array
        #   items:
        #     $ref: '#/components/schemas/Card'
            
    GameState:
      description: The complete state of a match.
      type: object
      properties:
        game_id:
          type: string
          format: uuid
        turn_number:
          type: integer
          example: 3
        winner:
          type: string
          nullable: true
          example: null
        scores:
          type: object
          additionalProperties:
            type: integer
          example: {"Alice": 2, "Bob": 1}
        players:
          type: array
          items:
            $ref: '#/components/schemas/PlayerState'
        turn_history:
          type: array
          description: History of played turns.
          items:
            type: object # This schema can be further detailed if needed
            
    WaitingResponse:
      description: Response sent when the first player has played and is waiting for the second.
      type: object
      properties:
        status:
          type: string
          example: "waiting"

    ResolvedResponse:
      description: Response sent after both have played and the round is resolved.
      type: object
      properties:
        status:
          type: string
          example: "resolved"
        message:
          type: string
          example: "Alice wins round 1!"
        scores:
          type: object
          additionalProperties:
            type: integer
          example: {"Alice": 1, "Bob": 0}
        turn_number:
          type: integer
          example: 1
        match_winner:
          type: string
          nullable: true
          example: null

    WaitingForMatch:
      type: object
      properties:
        status:
          type: string
          example: "waiting"
        message:
          type: string
          example: "Waiting for opponent..."
          
    MatchCreated:
      type: object
      properties:
        status:
          type: string
          example: "matched"
        game_id:
          type: string
          format: uuid
        opponent:
          type: string
          example: "Bob"
        role:
          type: string
          example: "player2"

    FinishedResponse:
      type: object
      properties:
        status:
          type: string
          example: "finished"
        match_winner:
          type: string
          example: "Alice"
        message:
          type: string
          example: "Game Over! Result: Alice"
        scores:
          type: object
          additionalProperties:
            type: integer
          example: {"Alice": 5, "Bob": 3}

    Error:
      type: object
      properties:
        error:
          type: string
      required:
        - error

  responses:
    BadRequest:
      description: Invalid request (e.g. missing data, failed validation).
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "deck_slot is required"
    Unauthorized:
      description: Unauthorized (missing or invalid token).
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "Invalid token or user service unreachable"
    NotFound:
      description: Resource not found (e.g. invalid game_id).
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "Invalid game ID"
    ServerError:
      description: Internal server error (e.g. unable to contact another service).
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "Could not reach collection service"