{
	"info": {
		"_postman_id": "game_history_ut",
		"name": "Game History Unit Tests",
		"schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
	},
	"item": [
		{
			"name": "Setup",
			"item": [
				{
					"name": "Add Usernames (Seed >10 Users)",
					"request": {
						"method": "POST",
						"header": [],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"{{user1_id}}\": \"alice\",\n  \"{{user2_id}}\": \"bob\",\n  \"{{user3_id}}\": \"user3\",\n  \"{{user4_id}}\": \"user4\",\n  \"{{user5_id}}\": \"user5\",\n  \"{{user6_id}}\": \"user6\",\n  \"{{user7_id}}\": \"user7\",\n  \"{{user8_id}}\": \"user8\",\n  \"{{user9_id}}\": \"user9\",\n  \"{{user10_id}}\": \"user10\",\n  \"{{user11_id}}\": \"user11\",\n  \"{{user12_id}}\": \"user12\"\n}",
							"options": {
								"raw": {
									"language": "json"
								}
							}
						},
						"url": {
							"raw": "{{base_url}}/addusernames",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"addusernames"
							]
						}
					},
					"response": []
				},
				{
					"name": "Add Matches (Bulk Seed + Pagination)",
					"request": {
						"method": "POST",
						"header": [],
						"body": {
							"mode": "raw",
							"raw": "[\n  {\n    \"player1\": \"{{user1_id}}\",\n    \"player2\": \"{{user2_id}}\",\n    \"winner\": \"1\",\n    \"points1\": 10,\n    \"points2\": -5,\n    \"started_at\": 1700000000,\n    \"ended_at\": 1700000100\n  },\n  {\n    \"player1\": \"{{user1_id}}\",\n    \"player2\": \"{{user2_id}}\",\n    \"winner\": \"2\",\n    \"points1\": -5,\n    \"points2\": 15,\n    \"started_at\": 1700000200,\n    \"ended_at\": 1700000300\n  },\n  {\n    \"player1\": \"{{user1_id}}\",\n    \"player2\": \"{{user2_id}}\",\n    \"winner\": \"draw\",\n    \"points1\": 5,\n    \"points2\": 5,\n    \"started_at\": 1700000400,\n    \"ended_at\": 1700000500\n  },\n\n  {\n    \"player1\": \"{{user1_id}}\",\n    \"player2\": \"{{user3_id}}\",\n    \"winner\": \"1\",\n    \"points1\": 3,\n    \"points2\": -1,\n    \"started_at\": 1700000600,\n    \"ended_at\": 1700000700\n  },\n  {\n    \"player1\": \"{{user1_id}}\",\n    \"player2\": \"{{user4_id}}\",\n    \"winner\": \"1\",\n    \"points1\": 4,\n    \"points2\": -1,\n    \"started_at\": 1700000800,\n    \"ended_at\": 1700000900\n  },\n  {\n    \"player1\": \"{{user1_id}}\",\n    \"player2\": \"{{user5_id}}\",\n    \"winner\": \"1\",\n    \"points1\": 5,\n    \"points2\": -2,\n    \"started_at\": 1700001000,\n    \"ended_at\": 1700001100\n  },\n  {\n    \"player1\": \"{{user1_id}}\",\n    \"player2\": \"{{user6_id}}\",\n    \"winner\": \"1\",\n    \"points1\": 6,\n    \"points2\": -3,\n    \"started_at\": 1700001200,\n    \"ended_at\": 1700001300\n  },\n  {\n    \"player1\": \"{{user1_id}}\",\n    \"player2\": \"{{user7_id}}\",\n    \"winner\": \"1\",\n    \"points1\": 7,\n    \"points2\": -4,\n    \"started_at\": 1700001400,\n    \"ended_at\": 1700001500\n  },\n  {\n    \"player1\": \"{{user1_id}}\",\n    \"player2\": \"{{user8_id}}\",\n    \"winner\": \"1\",\n    \"points1\": 8,\n    \"points2\": -5,\n    \"started_at\": 1700001600,\n    \"ended_at\": 1700001700\n  },\n  {\n    \"player1\": \"{{user1_id}}\",\n    \"player2\": \"{{user9_id}}\",\n    \"winner\": \"1\",\n    \"points1\": 9,\n    \"points2\": -6,\n    \"started_at\": 1700001800,\n    \"ended_at\": 1700001900\n  },\n  {\n    \"player1\": \"{{user1_id}}\",\n    \"player2\": \"{{user10_id}}\",\n    \"winner\": \"1\",\n    \"points1\": 10,\n    \"points2\": -7,\n    \"started_at\": 1700002000,\n    \"ended_at\": 1700002100\n  },\n  {\n    \"player1\": \"{{user1_id}}\",\n    \"player2\": \"{{user11_id}}\",\n    \"winner\": \"1\",\n    \"points1\": 11,\n    \"points2\": -8,\n    \"started_at\": 1700002200,\n    \"ended_at\": 1700002300\n  },\n  {\n    \"player1\": \"{{user1_id}}\",\n    \"player2\": \"{{user12_id}}\",\n    \"winner\": \"1\",\n    \"points1\": 12,\n    \"points2\": -9,\n    \"started_at\": 1700002400,\n    \"ended_at\": 1700002500\n  }\n]",
							"options": {
								"raw": {
									"language": "json"
								}
							}
						},
						"url": {
							"raw": "{{base_url}}/addmatches",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"addmatches"
							]
						}
					},
					"response": []
				}
			]
		},
		{
			"name": "Tests",
			"item": [
				{
					"name": "Get Matches - Page 0",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test(\"Status code is 200\", function () {",
									"    pm.response.to.have.status(200);",
									"});",
									"pm.test(\"Response is a page (<= 10)\", function () {",
									"    var jsonData = pm.response.json();",
									"    pm.expect(jsonData).to.be.an('array');",
									"    pm.expect(jsonData.length).to.be.at.most(10);",
									"    if (jsonData.length > 0) {",
									"        pm.expect(jsonData[0]).to.have.property('_id');",
									"        pm.expect(jsonData[0]).to.have.property('row_number');",
									"        pm.expect(jsonData[0].row_number).to.be.within(1, 10);",
									"        pm.collectionVariables.set('matches_page0_first_id', jsonData[0]._id);",
									"    }",
									"});"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "GET",
						"header": [
							{
								"key": "Authorization",
								"value": "Bearer {{user1_id}}",
								"type": "text"
							}
						],
						"url": {
							"raw": "{{base_url}}/matches?page=0",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"matches"
							],
							"query": [
								{
									"key": "page",
									"value": "0"
								}
							]
						}
					},
					"response": []
				},
				{
					"name": "Get Matches - Page 1",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test(\"Status code is 200\", function () {",
									"    pm.response.to.have.status(200);",
									"});",
									"pm.test(\"Response is page 1 (<= 10) and distinct\", function () {",
									"    var jsonData = pm.response.json();",
									"    pm.expect(jsonData).to.be.an('array');",
									"    pm.expect(jsonData.length).to.be.at.most(10);",
									"    pm.expect(jsonData.length).to.be.above(0);",
									"    pm.expect(jsonData[0]).to.have.property('_id');",
									"    if (jsonData[0].row_number !== undefined) {",
									"        pm.expect(jsonData[0].row_number).to.be.at.least(11);",
									"    }",
									"    var page0FirstId = pm.collectionVariables.get('matches_page0_first_id');",
									"    if (page0FirstId) {",
									"        pm.expect(jsonData[0]._id).to.not.eql(page0FirstId);",
									"    }",
									"});"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "GET",
						"header": [
							{
								"key": "Authorization",
								"value": "Bearer {{user1_id}}",
								"type": "text"
							}
						],
						"url": {
							"raw": "{{base_url}}/matches?page=1",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"matches"
							],
							"query": [
								{
									"key": "page",
									"value": "1"
								}
							]
						}
					},
					"response": []
				},
				{
					"name": "Get Matches - Fail (Unauthorized)",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test(\"Status code is 401\", function () {",
									"    pm.response.to.have.status(401);",
									"});"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{base_url}}/matches",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"matches"
							]
						}
					},
					"response": []
				},
				{
					"name": "Get Leaderboard - Page 0",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test(\"Status code is 200\", function () {",
									"    pm.response.to.have.status(200);",
									"});",
									"pm.test(\"Response is a page (<= 10)\", function () {",
									"    var jsonData = pm.response.json();",
									"    pm.expect(jsonData).to.be.an('array');",
									"    pm.expect(jsonData.length).to.be.at.most(10);",
									"    pm.expect(jsonData.length).to.be.above(0);",
									"    var usernames = jsonData.map(function (x) { return x.username; });",
									"    pm.collectionVariables.set('leaderboard_page0_usernames', JSON.stringify(usernames));",
									"});"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{base_url}}/leaderboard?page=0",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"leaderboard"
							],
							"query": [
								{
									"key": "page",
									"value": "0"
								}
							]
						}
					},
					"response": []
				},
				{
					"name": "Get Leaderboard - Page 1",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test(\"Status code is 200\", function () {",
									"    pm.response.to.have.status(200);",
									"});",
									"pm.test(\"Page 1 exists and does not overlap page 0\", function () {",
									"    var jsonData = pm.response.json();",
									"    pm.expect(jsonData).to.be.an('array');",
									"    pm.expect(jsonData.length).to.be.at.most(10);",
									"    pm.expect(jsonData.length).to.be.above(0);",
									"    var page0 = pm.collectionVariables.get('leaderboard_page0_usernames');",
									"    var page0Usernames = page0 ? JSON.parse(page0) : [];",
									"    var page1Usernames = jsonData.map(function (x) { return x.username; });",
									"    var overlap = page1Usernames.filter(function (u) { return page0Usernames.indexOf(u) !== -1; });",
									"    pm.expect(overlap.length).to.eql(0);",
									"});"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{base_url}}/leaderboard?page=1",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"leaderboard"
							],
							"query": [
								{
									"key": "page",
									"value": "1"
								}
							]
						}
					},
					"response": []
				},
				{
					"name": "Get Leaderboard - Fail (Method Not Allowed)",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test(\"Status code is 405\", function () {",
									"    pm.response.to.have.status(405);",
									"});"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [],
						"url": {
							"raw": "{{base_url}}/leaderboard",
							"host": [
								"{{base_url}}"
							],
							"path": [
								"leaderboard"
							]
						}
					},
					"response": []
				}
			]
		}
	],
	"variable": [
		{
			"key": "base_url",
			"value": "http://localhost:5000",
			"type": "string"
		},
		{
			"key": "user1_id",
			"value": "11111111-1111-1111-1111-111111111111",
			"type": "string"
		},
		{
			"key": "user2_id",
			"value": "22222222-2222-2222-2222-222222222222",
			"type": "string"
		},
		{
			"key": "user3_id",
			"value": "33333333-3333-3333-3333-333333333333",
			"type": "string"
		},
		{
			"key": "user4_id",
			"value": "44444444-4444-4444-4444-444444444444",
			"type": "string"
		},
		{
			"key": "user5_id",
			"value": "55555555-5555-5555-5555-555555555555",
			"type": "string"
		},
		{
			"key": "user6_id",
			"value": "66666666-6666-6666-6666-666666666666",
			"type": "string"
		},
		{
			"key": "user7_id",
			"value": "77777777-7777-7777-7777-777777777777",
			"type": "string"
		},
		{
			"key": "user8_id",
			"value": "88888888-8888-8888-8888-888888888888",
			"type": "string"
		},
		{
			"key": "user9_id",
			"value": "99999999-9999-9999-9999-999999999999",
			"type": "string"
		},
		{
			"key": "user10_id",
			"value": "aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa",
			"type": "string"
		},
		{
			"key": "user11_id",
			"value": "bbbbbbbb-bbbb-bbbb-bbbb-bbbbbbbbbbbb",
			"type": "string"
		},
		{
			"key": "user12_id",
			"value": "cccccccc-cccc-cccc-cccc-cccccccccccc",
			"type": "string"
		}
	]
}
